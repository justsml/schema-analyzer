var e="object"==typeof global&&global&&global.Object===Object&&global,t="object"==typeof self&&self&&self.Object===Object&&self,n=(e||t||Function("return this")()).Symbol,r=Object.prototype,u=r.hasOwnProperty,i=r.toString,s=n?n.toStringTag:void 0;var o=Object.prototype.toString;var l=n?n.toStringTag:void 0;function c(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":l&&l in Object(e)?function(e){var t=u.call(e,s),n=e[s];try{e[s]=void 0;var r=!0}catch(e){}var o=i.call(e);return r&&(t?e[s]=n:delete e[s]),o}(e):function(e){return o.call(e)}(e)}var a="object"==typeof exports&&exports&&!exports.nodeType&&exports,p=a&&"object"==typeof module&&module&&!module.nodeType&&module,d=p&&p.exports===a&&e.process,h=function(){try{var e=p&&p.require&&p.require("util").types;return e||d&&d.binding&&d.binding("util")}catch(e){}}();var g,f=h&&h.isDate,y=f?(g=f,function(e){return g(e)}):function(e){return function(e){return null!=e&&"object"==typeof e}(e)&&"[object Date]"==c(e)};const m=["$","¬¢","¬£","¬§","¬•","÷è","ÿã","ﬂæ","ﬂø","‡ß≤","‡ß≥","‡ßª","‡´±","‡Øπ","‡∏ø","·üõ","‚Ç†","‚Ç°","‚Ç¢","‚Ç£","‚Ç§","‚Ç•","‚Ç¶","‚Çß","‚Ç®","‚Ç©","‚Ç™","‚Ç´","‚Ç¨","‚Ç≠","‚ÇÆ","‚ÇØ","‚Ç∞","‚Ç±","‚Ç≤","‚Ç≥","‚Ç¥","‚Çµ","‚Ç∂","‚Ç∑","‚Ç∏","‚Çπ","‚Ç∫","‚Çª","‚Çº","‚ÇΩ","‚Çæ","‚Çø","Í†∏","Ô∑º","Ôπ©","ÔºÑ","Ôø†","Ôø°","Ôø•","Ôø¶","ëøù","ëøû","ëøü","ëø†","ûãø","û≤∞"],b=/^([YN]|(TRUE)|(FALSE))$/i,S=/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/,w=/^[a-f\d]{24}$/i,q=/^([+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24:?00)([.,]\d+(?!:))?)?(\17[0-5]\d([.,]\d+)?)?([zZ]|([+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/,v=/^[12]\d{12}$/,j=/^-?[\d.,]+$/,$=/\d\.\d/,R=/^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/,k=/null/i;function T(e,t){return(e=String(e).trim()).length<30&&j.test(e)}const A=/^0+/;const N={type:"enum",matchBasicTypes:["String","Number"],check:(e,{rowCount:t,uniques:n},{enumAbsoluteLimit:r,enumPercentThreshold:u})=>{if(!n||0===n.length)return e;const i=Math.min(parseInt(String(t*u),10),r);return n.length>i?e:{enum:n,...e}}},F={type:"nullable",check:(e,{rowCount:t,uniques:n},{nullableRowsThreshold:r})=>{if(!n||0===n.length)return e;let u=0;return e&&e.Null&&(u+=e.Null.count),{nullable:!(u<=t*r),...e}}},O={type:"unique",check:(e,{rowCount:t,uniques:n},{uniqueRowsThreshold:r})=>{if(!n||0===n.length)return e;return{unique:n.length===t*r,...e}}},D={type:"Unknown",check:e=>void 0===e||"undefined"===e},I={type:"ObjectId",supercedes:["String"],check:function(e,t){return null!=e&&((e=String(e).trim()).length<40&&w.test(e))}},x={type:"UUID",supercedes:["String"],check:function(e,t){return null!=e&&((e=String(e).trim()).length<40&&S.test(e))}},P={type:"Boolean",supercedes:["String"],check:function(e,t){return null!=e&&((e=String(e).trim()).length<=6&&b.test(String(e)))}},C={type:"Date",supercedes:["String"],check:function(e,t){return null!=e&&(!!y(e)||(e=String(e).trim()).length<30&&q.test(e))}},E={type:"Timestamp",supercedes:["String","Number"],check:function(e){return null!=e&&(e=String(e).trim(),v.test(e))}},U={type:"Currency",supercedes:["String","Number"],check:function(e){if(null==e)return!1;e=String(e).trim();const t=m.find(t=>e.indexOf(t)>-1);return!!t&&T(e=e.replace(t,""))}},M={type:"Float",supercedes:["String","Number"],check:function(e){return!(!T(String(e))||!$.test(String(e))||Number.isInteger(e))}},z={type:"Number",check:e=>!A.test(String(e))&&!(null===e||Array.isArray(e)||!Number.isInteger(e)&&!T(e))},L={type:"Email",supercedes:["String"],check:function(e){return null!=e&&(!((e=String(e).trim()).includes(" ")||!e.includes("@"))&&(e.length>=5&&e.length<80&&R.test(e)))}},B={type:"String",check:e=>"string"==typeof e},_={type:"Array",check:e=>Array.isArray(e)},Y={type:"Object",check:e=>!Array.isArray(e)&&null!=e&&"object"==typeof e},W={type:"Null",check:function(e){return null===e||k.test(String(e).trim())}},Z=[D,I,x,P,C,E,U,M,z,W,L,B,_,Y],G={[D.type]:-1,[I.type]:1,[x.type]:2,[P.type]:3,[C.type]:4,[E.type]:5,[U.type]:6,[M.type]:7,[z.type]:8,[W.type]:10,[L.type]:11,[B.type]:12,[_.type]:13,[Y.type]:14},H=require("debug")("schema-builder:index");function J(e){return e=e instanceof Date?e:new Date(e),!isNaN(e.getFullYear())&&e}const K=e=>(e=J(e))&&e.toISOString&&e.toISOString();function Q(e,t,n={onProgress:({totalRows:e,currentRow:t})=>{},strictMatching:!0,disableNestedTypes:!1,enumMinimumRowCount:100,enumAbsoluteLimit:10,enumPercentThreshold:.01,nullableRowsThreshold:.02,uniqueRowsThreshold:1}){if(!Array.isArray(t)||"object"!=typeof t)throw Error("Input Data must be an Array of Objects");if("object"!=typeof t[0])throw Error("Input Data must be an Array of Objects");if(t.length<5)throw Error("Analysis requires at least 5 records. (Use 200+ for great results.)");const{onProgress:r=(({totalRows:e,currentRow:t})=>{}),strictMatching:u=!0,disableNestedTypes:i=!1,enumMinimumRowCount:s=100,enumAbsoluteLimit:o=10,enumPercentThreshold:l=.01,nullableRowsThreshold:c=.02,uniqueRowsThreshold:a=1}=n,p=t.length>=s,d={};return H("Starting"),Promise.resolve(t).then((function(e){const t={uniques:p?{}:null,fieldsData:{},totalRows:null};H(`  About to examine every row & cell. Found ${e.length} records...`);const n=e.reduce(g,t);return H("  Extracted data points from Field Type analysis"),n})).then(V).then(async e=>(H("Built summary from Field Type data."),{fields:Object.keys(e.fields).reduce((n,r)=>{const u=e.fields[r];return n[r]={...u},n[r]=N.check(n[r],{rowCount:t.length,uniques:e.uniques&&e.uniques[r]},{enumAbsoluteLimit:o,enumPercentThreshold:l}),n[r]=F.check(n[r],{rowCount:t.length,uniques:e.uniques&&e.uniques[r]},{nullableRowsThreshold:c}),n[r]=O.check(n[r],{rowCount:t.length,uniques:e.uniques&&e.uniques[r]},{uniqueRowsThreshold:a}),(u.Number||u.UUID)&&n[r].unique&&/id$/i.test(r)&&(n[r].identity=!0),e.uniques&&e.uniques[r]&&(n[r].uniqueCount=e.uniques[r].length),n},{}),totalRows:e.totalRows,nestedTypes:i?void 0:await h(d)}));function h(e){return Object.entries(e).reduce(async(e,[t,r])=>{const u=t.split("."),i=u[u.length-1];return e[t]=await Q(i,r,n),e},{})}function g(t,n,s,o){t.totalRows=t.totalRows||o.length;const l=Object.keys(n);return H(`Processing Row # ${s+1}/${t.totalRows}...`),l.forEach((r,s,o)=>{0===s&&H(`Found ${o.length} Column(s)!`);const l=n[r],c=function({value:e,strictMatching:t}){return function(e,t=!0){const n=[],r=Z.reduce((t,r)=>(r.check(e)&&(r.supercedes&&n.push(...r.supercedes),t.push(r.type)),t),[]);return t?r.filter(e=>-1===n.indexOf(e)):r}(e,t).reduce((t,n,r)=>{let u,i,s;if(t[n]={rank:r+1},"Array"===n&&(u=e.length,t[n]={...t[n],length:u}),"Float"===n){e=parseFloat(e),t[n]={...t[n],value:e};const r=String(e).split(".");2===r.length&&(i=r.join("").length,s=r[1].length,t[n]={...t[n],precision:i,scale:s})}if("Number"===n&&(e=Number(e),t[n]={...t[n],value:e}),"Date"===n||"Timestamp"===n){const r=J(e);r&&(t[n]={...t[n],value:r.getTime()})}return"String"!==n&&"Email"!==n||(u=String(e).length,t[n]={...t[n],length:u}),t},{})}({value:l,strictMatching:u}),a=Object.keys(c),h=a.includes("Number")||a.includes("String");i||Array.isArray(l)&&l.length>=1&&"object"==typeof l[0]&&(d[`${e}.${r}`]=d[`${e}.${r}`]||[],d[`${e}.${r}`].push(...l),c.$ref=`${e}.${r}`),p&&h&&(t.uniques[r]=t.uniques[r]||[],t.uniques[r].includes(l)||t.uniques[r].push(n[r])),t.fieldsData[r]=t.fieldsData[r]||[],t.fieldsData[r].push(c)}),r({totalRows:t.totalRows,currentRow:s+1}),t}}function V(e){const{fieldsData:t}=e,n=Object.keys(t),r={};return H(`Pre-condenseFieldSizes(fields[fieldName]) for ${n.length} columns`),n.forEach(e=>{const n=X(t[e]);if(r[e]=function(e){const t={};return H("Starting condenseFieldSizes()"),Object.keys(e).map(n=>{t[n]={rank:G[n]||-42,count:e[n].count},"$ref"===n?t[n].typeAlias=e.$ref:(e[n].value&&(t[n].value=ee(e[n].value)),e[n].length&&(t[n].length=ee(e[n].length,!0)),e[n].scale&&(t[n].scale=ee(e[n].scale,!0)),e[n].precision&&(t[n].precision=ee(e[n].precision,!0))),["Timestamp","Date"].indexOf(n)>-1&&(t[n].value=te(t[n].value,K))}),H("Done condenseFieldSizes()..."),t}(n),n.$ref&&n.$ref.count>1){const n=t[e].find(e=>e.$ref);r[e].$ref.typeAlias=n.$ref}}),H("Post-condenseFieldSizes(fields[fieldName])"),H("Replaced fieldData with fieldSummary"),{fields:r,uniques:e.uniques,totalRows:e.totalRows}}function X(e){return H(`Processing ${e.length} type guesses`),e.reduce((e,t)=>(Object.entries(t).map(([t,{value:n,length:r,scale:u,precision:i}])=>(e[t]=e[t]||{typeName:t,count:0},Number.isFinite(r)&&!e[t].length&&(e[t].length=[]),Number.isFinite(u)&&!e[t].scale&&(e[t].scale=[]),Number.isFinite(i)&&!e[t].precision&&(e[t].precision=[]),Number.isFinite(n)&&!e[t].value&&(e[t].value=[]),e[t].count++,r&&e[t].length.push(r),u&&e[t].scale.push(u),i&&e[t].precision.push(i),n&&e[t].value.push(n),e[t])),e),{})}function ee(e,t=!1){if(!e||e.length<1)return;const n=e.slice().sort((e,t)=>e<t?-1:e===t?0:1),r=e.reduce((e,t)=>e+t,0);return t&&(e=n),{min:n[0],mean:r/e.length,max:n[e.length-1],p25:e[parseInt(String(.25*e.length),10)],p33:e[parseInt(String(.33*e.length),10)],p50:e[parseInt(String(.5*e.length),10)],p66:e[parseInt(String(.66*e.length),10)],p75:e[parseInt(String(.75*e.length),10)],p99:e[parseInt(String(.99*e.length),10)]}}function te(e,t){return{min:t(e.min),mean:t(e.mean),max:t(e.max),p25:t(e.p25),p33:t(e.p33),p50:t(e.p50),p66:t(e.p66),p75:t(e.p75),p99:t(e.p99)}}export{V as _condenseFieldData,te as _formatRangeStats,ee as _getNumberRangeStats,X as _pivotFieldDataByType,ee as getNumberRangeStats,J as isValidDate,X as pivotFieldDataByType,Q as schemaAnalyzer};