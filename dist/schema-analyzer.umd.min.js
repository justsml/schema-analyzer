!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).schemaAnalyzer={})}(this,(function(e){"use strict";var t="object"==typeof global&&global&&global.Object===Object&&global,n="object"==typeof self&&self&&self.Object===Object&&self,r=(t||n||Function("return this")()).Symbol,i=Object.prototype,u=i.hasOwnProperty,s=i.toString,o=r?r.toStringTag:void 0;var l=Object.prototype.toString;var c=r?r.toStringTag:void 0;function a(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":c&&c in Object(e)?function(e){var t=u.call(e,o),n=e[o];try{e[o]=void 0;var r=!0}catch(e){}var i=s.call(e);return r&&(t?e[o]=n:delete e[o]),i}(e):function(e){return l.call(e)}(e)}var p="object"==typeof e&&e&&!e.nodeType&&e,d=p&&"object"==typeof module&&module&&!module.nodeType&&module,h=d&&d.exports===p&&t.process,g=function(){try{var e=d&&d.require&&d.require("util").types;return e||h&&h.binding&&h.binding("util")}catch(e){}}();var f,y=g&&g.isDate,m=y?(f=y,function(e){return f(e)}):function(e){return function(e){return null!=e&&"object"==typeof e}(e)&&"[object Date]"==a(e)};const b=["$","¬¢","¬£","¬§","¬•","÷è","ÿã","ﬂæ","ﬂø","‡ß≤","‡ß≥","‡ßª","‡´±","‡Øπ","‡∏ø","·üõ","‚Ç†","‚Ç°","‚Ç¢","‚Ç£","‚Ç§","‚Ç•","‚Ç¶","‚Çß","‚Ç®","‚Ç©","‚Ç™","‚Ç´","‚Ç¨","‚Ç≠","‚ÇÆ","‚ÇØ","‚Ç∞","‚Ç±","‚Ç≤","‚Ç≥","‚Ç¥","‚Çµ","‚Ç∂","‚Ç∑","‚Ç∏","‚Çπ","‚Ç∫","‚Çª","‚Çº","‚ÇΩ","‚Çæ","‚Çø","Í†∏","Ô∑º","Ôπ©","ÔºÑ","Ôø†","Ôø°","Ôø•","Ôø¶","ëøù","ëøû","ëøü","ëø†","ûãø","û≤∞"],S=/^([YN]|(TRUE)|(FALSE))$/i,w=/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/,q=/^[a-f\d]{24}$/i,v=/^([+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24:?00)([.,]\d+(?!:))?)?(\17[0-5]\d([.,]\d+)?)?([zZ]|([+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/,j=/^[12]\d{12}$/,R=/^-?[\d.,]+$/,$=/\d\.\d/,T=/^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/,k=/null/i;function A(e,t){return(e=String(e).trim()).length<30&&R.test(e)}const N=/^0+/;const F={type:"enum",matchBasicTypes:["String","Number"],check:(e,{rowCount:t,uniques:n},{enumAbsoluteLimit:r,enumPercentThreshold:i})=>{if(!n||0===n.length)return e;const u=Math.min(parseInt(String(t*i),10),r);return n.length>u?e:{enum:n,...e}}},O={type:"nullable",check:(e,{rowCount:t,uniques:n},{nullableRowsThreshold:r})=>{if(!n||0===n.length)return e;let i=0;return e&&e.Null&&(i+=e.Null.count),{nullable:!(i<=t*r),...e}}},D={type:"unique",check:(e,{rowCount:t,uniques:n},{uniqueRowsThreshold:r})=>{if(!n||0===n.length)return e;return{unique:n.length===t*r,...e}}},I={type:"Unknown",check:e=>void 0===e||"undefined"===e},x={type:"ObjectId",supercedes:["String"],check:function(e,t){return null!=e&&((e=String(e).trim()).length<40&&q.test(e))}},P={type:"UUID",supercedes:["String"],check:function(e,t){return null!=e&&((e=String(e).trim()).length<40&&w.test(e))}},C={type:"Boolean",supercedes:["String"],check:function(e,t){return null!=e&&((e=String(e).trim()).length<=6&&S.test(String(e)))}},E={type:"Date",supercedes:["String"],check:function(e,t){return null!=e&&(!!m(e)||(e=String(e).trim()).length<30&&v.test(e))}},M={type:"Timestamp",supercedes:["String","Number"],check:function(e){return null!=e&&(e=String(e).trim(),j.test(e))}},U={type:"Currency",supercedes:["String","Number"],check:function(e){if(null==e)return!1;e=String(e).trim();const t=b.find(t=>e.indexOf(t)>-1);return!!t&&A(e=e.replace(t,""))}},z={type:"Float",supercedes:["String","Number"],check:function(e){return!(!A(String(e))||!$.test(String(e))||Number.isInteger(e))}},B={type:"Number",check:e=>!N.test(String(e))&&!(null===e||Array.isArray(e)||!Number.isInteger(e)&&!A(e))},_={type:"Email",supercedes:["String"],check:function(e){return null!=e&&(!((e=String(e).trim()).includes(" ")||!e.includes("@"))&&(e.length>=5&&e.length<80&&T.test(e)))}},L={type:"String",check:e=>"string"==typeof e},Y={type:"Array",check:e=>Array.isArray(e)},V={type:"Object",check:e=>!Array.isArray(e)&&null!=e&&"object"==typeof e},W={type:"Null",check:function(e){return null===e||k.test(String(e).trim())}},Z=[I,x,P,C,E,M,U,z,B,W,_,L,Y,V],G={[I.type]:-1,[x.type]:1,[P.type]:2,[C.type]:3,[E.type]:4,[M.type]:5,[U.type]:6,[z.type]:7,[B.type]:8,[W.type]:10,[_.type]:11,[L.type]:12,[Y.type]:13,[V.type]:14},H=require("debug")("schema-builder:index");function J(e){return e=e instanceof Date?e:new Date(e),!isNaN(e.getFullYear())&&e}const K=e=>(e=J(e))&&e.toISOString&&e.toISOString();function Q(e){const{fieldsData:t}=e,n=Object.keys(t),r={};return H(`Pre-condenseFieldSizes(fields[fieldName]) for ${n.length} columns`),n.forEach(e=>{const n=X(t[e]);if(r[e]=function(e){const t={};return H("Starting condenseFieldSizes()"),Object.keys(e).map(n=>{t[n]={rank:G[n]||-42,count:e[n].count},"$ref"===n?t[n].typeAlias=e.$ref:(e[n].value&&(t[n].value=ee(e[n].value)),e[n].length&&(t[n].length=ee(e[n].length,!0)),e[n].scale&&(t[n].scale=ee(e[n].scale,!0)),e[n].precision&&(t[n].precision=ee(e[n].precision,!0))),["Timestamp","Date"].indexOf(n)>-1&&(t[n].value=te(t[n].value,K))}),H("Done condenseFieldSizes()..."),t}(n),n.$ref&&n.$ref.count>1){const n=t[e].find(e=>e.$ref);r[e].$ref.typeAlias=n.$ref}}),H("Post-condenseFieldSizes(fields[fieldName])"),H("Replaced fieldData with fieldSummary"),{fields:r,uniques:e.uniques,totalRows:e.totalRows}}function X(e){return H(`Processing ${e.length} type guesses`),e.reduce((e,t)=>(Object.entries(t).map(([t,{value:n,length:r,scale:i,precision:u}])=>(e[t]=e[t]||{typeName:t,count:0},Number.isFinite(r)&&!e[t].length&&(e[t].length=[]),Number.isFinite(i)&&!e[t].scale&&(e[t].scale=[]),Number.isFinite(u)&&!e[t].precision&&(e[t].precision=[]),Number.isFinite(n)&&!e[t].value&&(e[t].value=[]),e[t].count++,r&&e[t].length.push(r),i&&e[t].scale.push(i),u&&e[t].precision.push(u),n&&e[t].value.push(n),e[t])),e),{})}function ee(e,t=!1){if(!e||e.length<1)return;const n=e.slice().sort((e,t)=>e<t?-1:e===t?0:1),r=e.reduce((e,t)=>e+t,0);return t&&(e=n),{min:n[0],mean:r/e.length,max:n[e.length-1],p25:e[parseInt(String(.25*e.length),10)],p33:e[parseInt(String(.33*e.length),10)],p50:e[parseInt(String(.5*e.length),10)],p66:e[parseInt(String(.66*e.length),10)],p75:e[parseInt(String(.75*e.length),10)],p99:e[parseInt(String(.99*e.length),10)]}}function te(e,t){return{min:t(e.min),mean:t(e.mean),max:t(e.max),p25:t(e.p25),p33:t(e.p33),p50:t(e.p50),p66:t(e.p66),p75:t(e.p75),p99:t(e.p99)}}e._condenseFieldData=Q,e._formatRangeStats=te,e._getNumberRangeStats=ee,e._pivotFieldDataByType=X,e.getNumberRangeStats=ee,e.isValidDate=J,e.pivotFieldDataByType=X,e.schemaBuilder=function e(t,n,r={onProgress:({totalRows:e,currentRow:t})=>{},strictMatching:!0,disableNestedTypes:!1,enumMinimumRowCount:100,enumAbsoluteLimit:10,enumPercentThreshold:.01,nullableRowsThreshold:.02,uniqueRowsThreshold:1}){if(!Array.isArray(n)||"object"!=typeof n)throw Error("Input Data must be an Array of Objects");if("object"!=typeof n[0])throw Error("Input Data must be an Array of Objects");if(n.length<5)throw Error("Analysis requires at least 5 records. (Use 200+ for great results.)");const{onProgress:i=(({totalRows:e,currentRow:t})=>{}),strictMatching:u=!0,disableNestedTypes:s=!1,enumMinimumRowCount:o=100,enumAbsoluteLimit:l=10,enumPercentThreshold:c=.01,nullableRowsThreshold:a=.02,uniqueRowsThreshold:p=1}=r,d=n.length>=o,h={};return H("Starting"),Promise.resolve(n).then((function(e){const t={uniques:d?{}:null,fieldsData:{},totalRows:null};H(`  About to examine every row & cell. Found ${e.length} records...`);const n=e.reduce(f,t);return H("  Extracted data points from Field Type analysis"),n})).then(Q).then(async e=>(H("Built summary from Field Type data."),{fields:Object.keys(e.fields).reduce((t,r)=>{const i=e.fields[r];return t[r]={...i},t[r]=F.check(t[r],{rowCount:n.length,uniques:e.uniques&&e.uniques[r]},{enumAbsoluteLimit:l,enumPercentThreshold:c}),t[r]=O.check(t[r],{rowCount:n.length,uniques:e.uniques&&e.uniques[r]},{nullableRowsThreshold:a}),t[r]=D.check(t[r],{rowCount:n.length,uniques:e.uniques&&e.uniques[r]},{uniqueRowsThreshold:p}),(i.Number||i.UUID)&&t[r].unique&&/id$/i.test(r)&&(t[r].identity=!0),e.uniques&&e.uniques[r]&&(t[r].uniqueCount=e.uniques[r].length),t},{}),totalRows:e.totalRows,nestedTypes:s?void 0:await g(h)}));function g(t){return Object.entries(t).reduce(async(t,[n,i])=>{const u=n.split("."),s=u[u.length-1];return t[n]=await e(s,i,r),t},{})}function f(e,n,r,o){e.totalRows=e.totalRows||o.length;const l=Object.keys(n);return H(`Processing Row # ${r+1}/${e.totalRows}...`),l.forEach((r,i,o)=>{0===i&&H(`Found ${o.length} Column(s)!`);const l=n[r],c=function({value:e,strictMatching:t}){return function(e,t=!0){const n=[],r=Z.reduce((t,r)=>(r.check(e)&&(r.supercedes&&n.push(...r.supercedes),t.push(r.type)),t),[]);return t?r.filter(e=>-1===n.indexOf(e)):r}(e,t).reduce((t,n,r)=>{let i,u,s;if(t[n]={rank:r+1},"Array"===n&&(i=e.length,t[n]={...t[n],length:i}),"Float"===n){e=parseFloat(e),t[n]={...t[n],value:e};const r=String(e).split(".");2===r.length&&(u=r.join("").length,s=r[1].length,t[n]={...t[n],precision:u,scale:s})}if("Number"===n&&(e=Number(e),t[n]={...t[n],value:e}),"Date"===n||"Timestamp"===n){const r=J(e);r&&(t[n]={...t[n],value:r.getTime()})}return"String"!==n&&"Email"!==n||(i=String(e).length,t[n]={...t[n],length:i}),t},{})}({value:l,strictMatching:u}),a=Object.keys(c),p=a.includes("Number")||a.includes("String");s||Array.isArray(l)&&l.length>=1&&"object"==typeof l[0]&&(h[`${t}.${r}`]=h[`${t}.${r}`]||[],h[`${t}.${r}`].push(...l),c.$ref=`${t}.${r}`),d&&p&&(e.uniques[r]=e.uniques[r]||[],e.uniques[r].includes(l)||e.uniques[r].push(n[r])),e.fieldsData[r]=e.fieldsData[r]||[],e.fieldsData[r].push(c)}),i({totalRows:e.totalRows,currentRow:r+1}),e}},Object.defineProperty(e,"__esModule",{value:!0})}));