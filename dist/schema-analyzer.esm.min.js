"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e="object"==typeof global&&global&&global.Object===Object&&global,t="object"==typeof self&&self&&self.Object===Object&&self,n=(e||t||Function("return this")()).Symbol,r=Object.prototype,i=r.hasOwnProperty,u=r.toString,s=n?n.toStringTag:void 0;var o=Object.prototype.toString;var l=n?n.toStringTag:void 0;function c(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":l&&l in Object(e)?function(e){var t=i.call(e,s),n=e[s];try{e[s]=void 0;var r=!0}catch(e){}var o=u.call(e);return r&&(t?e[s]=n:delete e[s]),o}(e):function(e){return o.call(e)}(e)}var a="object"==typeof exports&&exports&&!exports.nodeType&&exports,p=a&&"object"==typeof module&&module&&!module.nodeType&&module,d=p&&p.exports===a&&e.process,h=function(){try{var e=p&&p.require&&p.require("util").types;return e||d&&d.binding&&d.binding("util")}catch(e){}}();var g,f=h&&h.isDate,y=f?(g=f,function(e){return g(e)}):function(e){return function(e){return null!=e&&"object"==typeof e}(e)&&"[object Date]"==c(e)};const m=["$","¬¢","¬£","¬§","¬•","÷è","ÿã","ﬂæ","ﬂø","‡ß≤","‡ß≥","‡ßª","‡´±","‡Øπ","‡∏ø","·üõ","‚Ç†","‚Ç°","‚Ç¢","‚Ç£","‚Ç§","‚Ç•","‚Ç¶","‚Çß","‚Ç®","‚Ç©","‚Ç™","‚Ç´","‚Ç¨","‚Ç≠","‚ÇÆ","‚ÇØ","‚Ç∞","‚Ç±","‚Ç≤","‚Ç≥","‚Ç¥","‚Çµ","‚Ç∂","‚Ç∑","‚Ç∏","‚Çπ","‚Ç∫","‚Çª","‚Çº","‚ÇΩ","‚Çæ","‚Çø","Í†∏","Ô∑º","Ôπ©","ÔºÑ","Ôø†","Ôø°","Ôø•","Ôø¶","ëøù","ëøû","ëøü","ëø†","ûãø","û≤∞"],b=/^([YN]|(TRUE)|(FALSE))$/i,S=/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/,w=/^[a-f\d]{24}$/i,q=/^([+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24:?00)([.,]\d+(?!:))?)?(\17[0-5]\d([.,]\d+)?)?([zZ]|([+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/,v=/^[12]\d{12}$/,j=/^-?[\d.,]+$/,R=/\d\.\d/,$=/^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/,T=/null/i;function k(e,t){return(e=String(e).trim()).length<30&&j.test(e)}const N=/^0+/;const A={type:"enum",matchBasicTypes:["String","Number"],check:(e,{rowCount:t,uniques:n},{enumAbsoluteLimit:r,enumPercentThreshold:i})=>{if(!n||0===n.length)return e;const u=Math.min(parseInt(String(t*i),10),r);return n.length>u?e:{enum:n,...e}}},F={type:"nullable",check:(e,{rowCount:t,uniques:n},{nullableRowsThreshold:r})=>{if(!n||0===n.length)return e;let i=0;return e&&e.Null&&(i+=e.Null.count),{nullable:!(i<=t*r),...e}}},O={type:"unique",check:(e,{rowCount:t,uniques:n},{uniqueRowsThreshold:r})=>{if(!n||0===n.length)return e;return{unique:n.length===t*r,...e}}},x={type:"Unknown",check:e=>void 0===e||"undefined"===e},D={type:"ObjectId",supercedes:["String"],check:function(e,t){return null!=e&&((e=String(e).trim()).length<40&&w.test(e))}},I={type:"UUID",supercedes:["String"],check:function(e,t){return null!=e&&((e=String(e).trim()).length<40&&S.test(e))}},P={type:"Boolean",supercedes:["String"],check:function(e,t){return null!=e&&((e=String(e).trim()).length<=6&&b.test(String(e)))}},C={type:"Date",supercedes:["String"],check:function(e,t){return null!=e&&(!!y(e)||(e=String(e).trim()).length<30&&q.test(e))}},E={type:"Timestamp",supercedes:["String","Number"],check:function(e){return null!=e&&(e=String(e).trim(),v.test(e))}},M={type:"Currency",supercedes:["String","Number"],check:function(e){if(null==e)return!1;e=String(e).trim();const t=m.find(t=>e.indexOf(t)>-1);return!!t&&k(e=e.replace(t,""))}},U={type:"Float",supercedes:["String","Number"],check:function(e){return!(!k(String(e))||!R.test(String(e))||Number.isInteger(e))}},B={type:"Number",check:e=>!N.test(String(e))&&!(null===e||Array.isArray(e)||!Number.isInteger(e)&&!k(e))},_={type:"Email",supercedes:["String"],check:function(e){return null!=e&&(!((e=String(e).trim()).includes(" ")||!e.includes("@"))&&(e.length>=5&&e.length<80&&$.test(e)))}},z={type:"String",check:e=>"string"==typeof e},L={type:"Array",check:e=>Array.isArray(e)},Y={type:"Object",check:e=>!Array.isArray(e)&&null!=e&&"object"==typeof e},V={type:"Null",check:function(e){return null===e||T.test(String(e).trim())}},W=[x,D,I,P,C,E,M,U,B,V,_,z,L,Y],Z={[x.type]:-1,[D.type]:1,[I.type]:2,[P.type]:3,[C.type]:4,[E.type]:5,[M.type]:6,[U.type]:7,[B.type]:8,[V.type]:10,[_.type]:11,[z.type]:12,[L.type]:13,[Y.type]:14},G=require("debug")("schema-builder:index");function H(e){return e=e instanceof Date?e:new Date(e),!isNaN(e.getFullYear())&&e}const J=e=>(e=H(e))&&e.toISOString&&e.toISOString();function K(e){const{fieldsData:t}=e,n=Object.keys(t),r={};return G(`Pre-condenseFieldSizes(fields[fieldName]) for ${n.length} columns`),n.forEach(e=>{const n=Q(t[e]);if(r[e]=function(e){const t={};return G("Starting condenseFieldSizes()"),Object.keys(e).map(n=>{t[n]={rank:Z[n]||-42,count:e[n].count},"$ref"===n?t[n].typeAlias=e.$ref:(e[n].value&&(t[n].value=X(e[n].value)),e[n].length&&(t[n].length=X(e[n].length,!0)),e[n].scale&&(t[n].scale=X(e[n].scale,!0)),e[n].precision&&(t[n].precision=X(e[n].precision,!0))),["Timestamp","Date"].indexOf(n)>-1&&(t[n].value=ee(t[n].value,J))}),G("Done condenseFieldSizes()..."),t}(n),n.$ref&&n.$ref.count>1){const n=t[e].find(e=>e.$ref);r[e].$ref.typeAlias=n.$ref}}),G("Post-condenseFieldSizes(fields[fieldName])"),G("Replaced fieldData with fieldSummary"),{fields:r,uniques:e.uniques,totalRows:e.totalRows}}function Q(e){return G(`Processing ${e.length} type guesses`),e.reduce((e,t)=>(Object.entries(t).map(([t,{value:n,length:r,scale:i,precision:u}])=>(e[t]=e[t]||{typeName:t,count:0},Number.isFinite(r)&&!e[t].length&&(e[t].length=[]),Number.isFinite(i)&&!e[t].scale&&(e[t].scale=[]),Number.isFinite(u)&&!e[t].precision&&(e[t].precision=[]),Number.isFinite(n)&&!e[t].value&&(e[t].value=[]),e[t].count++,r&&e[t].length.push(r),i&&e[t].scale.push(i),u&&e[t].precision.push(u),n&&e[t].value.push(n),e[t])),e),{})}function X(e,t=!1){if(!e||e.length<1)return;const n=e.slice().sort((e,t)=>e<t?-1:e===t?0:1),r=e.reduce((e,t)=>e+t,0);return t&&(e=n),{min:n[0],mean:r/e.length,max:n[e.length-1],p25:e[parseInt(String(.25*e.length),10)],p33:e[parseInt(String(.33*e.length),10)],p50:e[parseInt(String(.5*e.length),10)],p66:e[parseInt(String(.66*e.length),10)],p75:e[parseInt(String(.75*e.length),10)],p99:e[parseInt(String(.99*e.length),10)]}}function ee(e,t){return{min:t(e.min),mean:t(e.mean),max:t(e.max),p25:t(e.p25),p33:t(e.p33),p50:t(e.p50),p66:t(e.p66),p75:t(e.p75),p99:t(e.p99)}}exports._condenseFieldData=K,exports._formatRangeStats=ee,exports._getNumberRangeStats=X,exports._pivotFieldDataByType=Q,exports.getNumberRangeStats=X,exports.isValidDate=H,exports.pivotFieldDataByType=Q,exports.schemaBuilder=function e(t,n,r={onProgress:({totalRows:e,currentRow:t})=>{},strictMatching:!0,disableNestedTypes:!1,enumMinimumRowCount:100,enumAbsoluteLimit:10,enumPercentThreshold:.01,nullableRowsThreshold:.02,uniqueRowsThreshold:1}){if(!Array.isArray(n)||"object"!=typeof n)throw Error("Input Data must be an Array of Objects");if("object"!=typeof n[0])throw Error("Input Data must be an Array of Objects");if(n.length<5)throw Error("Analysis requires at least 5 records. (Use 200+ for great results.)");const{onProgress:i=(({totalRows:e,currentRow:t})=>{}),strictMatching:u=!0,disableNestedTypes:s=!1,enumMinimumRowCount:o=100,enumAbsoluteLimit:l=10,enumPercentThreshold:c=.01,nullableRowsThreshold:a=.02,uniqueRowsThreshold:p=1}=r,d=n.length>=o,h={};return G("Starting"),Promise.resolve(n).then((function(e){const t={uniques:d?{}:null,fieldsData:{},totalRows:null};G(`  About to examine every row & cell. Found ${e.length} records...`);const n=e.reduce(f,t);return G("  Extracted data points from Field Type analysis"),n})).then(K).then(async e=>(G("Built summary from Field Type data."),{fields:Object.keys(e.fields).reduce((t,r)=>{const i=e.fields[r];return t[r]={...i},t[r]=A.check(t[r],{rowCount:n.length,uniques:e.uniques&&e.uniques[r]},{enumAbsoluteLimit:l,enumPercentThreshold:c}),t[r]=F.check(t[r],{rowCount:n.length,uniques:e.uniques&&e.uniques[r]},{nullableRowsThreshold:a}),t[r]=O.check(t[r],{rowCount:n.length,uniques:e.uniques&&e.uniques[r]},{uniqueRowsThreshold:p}),(i.Number||i.UUID)&&t[r].unique&&/id$/i.test(r)&&(t[r].identity=!0),e.uniques&&e.uniques[r]&&(t[r].uniqueCount=e.uniques[r].length),t},{}),totalRows:e.totalRows,nestedTypes:s?void 0:await g(h)}));function g(t){return Object.entries(t).reduce(async(t,[n,i])=>{const u=n.split("."),s=u[u.length-1];return t[n]=await e(s,i,r),t},{})}function f(e,n,r,o){e.totalRows=e.totalRows||o.length;const l=Object.keys(n);return G(`Processing Row # ${r+1}/${e.totalRows}...`),l.forEach((r,i,o)=>{0===i&&G(`Found ${o.length} Column(s)!`);const l=n[r],c=function({value:e,strictMatching:t}){return function(e,t=!0){const n=[],r=W.reduce((t,r)=>(r.check(e)&&(r.supercedes&&n.push(...r.supercedes),t.push(r.type)),t),[]);return t?r.filter(e=>-1===n.indexOf(e)):r}(e,t).reduce((t,n,r)=>{let i,u,s;if(t[n]={rank:r+1},"Array"===n&&(i=e.length,t[n]={...t[n],length:i}),"Float"===n){e=parseFloat(e),t[n]={...t[n],value:e};const r=String(e).split(".");2===r.length&&(u=r.join("").length,s=r[1].length,t[n]={...t[n],precision:u,scale:s})}if("Number"===n&&(e=Number(e),t[n]={...t[n],value:e}),"Date"===n||"Timestamp"===n){const r=H(e);r&&(t[n]={...t[n],value:r.getTime()})}return"String"!==n&&"Email"!==n||(i=String(e).length,t[n]={...t[n],length:i}),t},{})}({value:l,strictMatching:u}),a=Object.keys(c),p=a.includes("Number")||a.includes("String");s||Array.isArray(l)&&l.length>=1&&"object"==typeof l[0]&&(h[`${t}.${r}`]=h[`${t}.${r}`]||[],h[`${t}.${r}`].push(...l),c.$ref=`${t}.${r}`),d&&p&&(e.uniques[r]=e.uniques[r]||[],e.uniques[r].includes(l)||e.uniques[r].push(n[r])),e.fieldsData[r]=e.fieldsData[r]||[],e.fieldsData[r].push(c)}),i({totalRows:e.totalRows,currentRow:r+1}),e}};